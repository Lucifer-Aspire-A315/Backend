// RN Fintech - Prisma Schema (Draft)
// Database: PostgreSQL
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Bank {
  id        String      @id @default(uuid())
  name      String      @unique
  loanTypes LoanType[]  @relation("BankLoanTypes")
  bankers   BankerProfile[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
  DELETED
}

model User {
  id                            String              @id @default(uuid())
  name                          String
  email                         String              @unique
  phone                         String              @unique
  passwordHash                  String
  role                          Role
  status                        UserStatus          @default(ACTIVE)
  avatar                        String?
  loans                         Loan[]
  merchantLoans                 Loan[]              @relation("MerchantLoans")
  bankerLoans                   Loan[]              @relation("BankerLoans")
  kycDocs                       KYCDocument[]
  notifications                 Notification[]
  isEmailVerified               Boolean             @default(false)
  emailVerificationToken        String?
  emailVerificationTokenExpires DateTime?
  passwordResetToken            String?
  passwordResetTokenExpires     DateTime?
  createdAt                     DateTime            @default(now())
  updatedAt                     DateTime            @updatedAt
  merchantProfile               MerchantProfile?
  customerProfile               CustomerProfile?
  bankerProfile                 BankerProfile?
  documents                     Document[]
  updatedLoanStatuses           LoanStatusHistory[] @relation("UserUpdatedLoanStatuses")
  refreshTokens                 RefreshToken[]
}

model BankerProfile {
  userId     String       @id
  user       User         @relation(fields: [userId], references: [id])
  bankId     String
  bank       Bank         @relation(fields: [bankId], references: [id])
  branch     String
  pincode    String
  employeeId String?
  status     BankerStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

enum BankerStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

model Loan {
  id            String              @id @default(uuid())
  loanTypeId    String?
  loanType      LoanType?           @relation(fields: [loanTypeId], references: [id])
  amount        Decimal             @db.Decimal(18, 2)
  tenorMonths   Int?
  interestRate  Decimal?            @db.Decimal(5, 2)
  status        LoanStatus          @default(SUBMITTED)
  kycStatus     KYCStatus           @default(PENDING)
  metadata      Json                @default("{}")
  applicant     User                @relation(fields: [applicantId], references: [id])
  applicantId   String
  merchant      User?               @relation("MerchantLoans", fields: [merchantId], references: [id])
  merchantId    String?
  banker        User?               @relation("BankerLoans", fields: [bankerId], references: [id])
  bankerId      String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  auditLogs     AuditLog[]
  statusHistory LoanStatusHistory[]
  documents     Document[]

  @@index([merchantId])
  @@index([applicantId])
  @@index([status])
}

model LoanType {
  id          String   @id @default(uuid())
  name        String   @unique
  code        String?  @unique
  description String?
  interestRate Decimal @default(0.0) @db.Decimal(5, 2)
  minTenure    Int?    // in months
  maxTenure    Int?    // in months
  minAmount    Decimal? @db.Decimal(18, 2)
  maxAmount    Decimal? @db.Decimal(18, 2)
  schema      Json     @default("{}")
  requiredDocuments String[] @default([])
  loans       Loan[]
  banks       Bank[]   @relation("BankLoanTypes")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LoanStatusHistory {
  id          String     @id @default(uuid())
  loan        Loan       @relation(fields: [loanId], references: [id])
  loanId      String
  status      LoanStatus
  updatedBy   User       @relation("UserUpdatedLoanStatuses", fields: [updatedById], references: [id])
  updatedById String
  note        String?
  createdAt   DateTime   @default(now())
}

model MerchantProfile {
  id           String            @id @default(uuid())
  user         User              @relation(fields: [userId], references: [id])
  userId       String            @unique
  businessName String
  gstNumber    String?
  address      String?
  pincode      String?
  customers    CustomerProfile[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model CustomerProfile {
  id         String           @id @default(uuid())
  user       User             @relation(fields: [userId], references: [id])
  userId     String           @unique
  merchant   MerchantProfile? @relation(fields: [merchantId], references: [id])
  merchantId String?
  address    String?
  pincode    String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model Document {
  id         String   @id @default(uuid())
  user       User?    @relation(fields: [userId], references: [id])
  userId     String?
  loan       Loan?    @relation(fields: [loanId], references: [id])
  loanId     String?
  type       String
  publicId   String?
  secureUrl  String?
  url        String?
  filename   String?
  fileType   String?
  bytes      Int?
  uploaderId String?
  status     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model KYCDocument {
  id         String        @id @default(uuid())
  type       String
  url        String?
  status     KYCStatus     @default(PENDING)
  userId     String
  user       User          @relation(fields: [userId], references: [id])
  verifiedBy String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  auditLogs  KYCAuditLog[]
}

model Notification {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  type      String
  message   String
  status    String   @default("unread")
  createdAt DateTime @default(now())
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  actorId    String
  entityType String   @default("LOAN") // LOAN, USER, LOAN_TYPE
  entityId   String
  details    String?
  createdAt  DateTime @default(now())

  // Optional relation to Loan (for backward compatibility and easy joins)
  loan       Loan?    @relation(fields: [loanId], references: [id])
  loanId     String?
}

model KYCAuditLog {
  id        String      @id @default(uuid())
  kycDoc    KYCDocument @relation(fields: [kycDocId], references: [id])
  kycDocId  String
  action    String
  actorId   String?
  details   String?
  createdAt DateTime    @default(now())
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum Role {
  CUSTOMER
  MERCHANT
  BANKER
  ADMIN
}

enum LoanStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  DISBURSED
  CANCELLED
}

enum KYCStatus {
  PENDING
  VERIFIED
  REJECTED
  UPLOADING
}
